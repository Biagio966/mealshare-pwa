<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gnammi</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7f6;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2e7d32;
    }
    .box {
      background: white;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button {
      background: #2ecc71;
      color: white;
      border: none;
      font-weight: bold;
    }
    button.secondary {
      background: #bdc3c7;
      color: #333;
    }
    #app {
      display: none;
    }
    #authMessage {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>

<h1>üçΩÔ∏è Gnammi</h1>

<!-- AUTH -->
<div class="box" id="authBox">
  <h3>Accedi o Registrati</h3>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">

  <button onclick="signUp()">Registrati</button>
  <button class="secondary" onclick="signIn()">Accedi</button>

  <p id="authMessage"></p>
</div>

<!-- APP -->
<div id="app">
  <div class="box">
    <p>üëã Ciao <span id="userEmail"></span></p>
    <button class="secondary" onclick="logout()">Logout</button>
  </div>

  <div class="box">
    <h3>Crea un pasto</h3>
    <input id="mealName" placeholder="Nome del pasto">
    <input id="mealCost" placeholder="Costo (es. 6.50)">
    <button onclick="saveMeal()">Salva pasto</button>
  </div>

  <div class="box">
    <h3>Pasti</h3>
    <div id="mealsList">Caricamento...</div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://zboefxtsggvkbinxlyux.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpib2VmeHRzZ2d2a2JpbnhseXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NzMzNjQsImV4cCI6MjA4MTI0OTM2NH0.5uQaO-cKGxrdSiZPvjmqZE3jdYo0qo2uDdGUvrpQqEM";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---------- AUTH ----------
  async function signUp() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    const { error } = await supabase.auth.signUp({
      email,
      password
    });

    if (error) {
      showMessage(error.message, true);
    } else {
      showMessage("Registrazione completata. Controlla l‚Äôemail per confermare.");
    }
  }

  async function signIn() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) {
      showMessage("Email non confermata o credenziali errate", true);
      return;
    }

    showApp(data.user);
  }

  async function logout() {
    await supabase.auth.signOut();
    location.reload();
  }

  // ---------- MEALS ----------
  async function saveMeal() {
  const name = document.getElementById("mealName").value;
  const cost = document.getElementById("mealCost").value;

  if (!name || !cost) {
    alert("Inserisci nome e costo");
    return;
  }

  navigator.geolocation.getCurrentPosition(async (position) => {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    const { data: { user } } = await supabase.auth.getUser();

    const { error } = await supabase.from("meals").insert([{
      name,
      cost,
      user_id: user.id,
      lat,
      lng
    }]);

    if (error) {
      alert(error.message);
    } else {
      alert("Pasto salvato con posizione üìç");
      loadMeals();
    }
  }, () => {
    alert("Devi consentire la posizione");
  });
}


    async function loadMeals() {
    const { data } = await supabase
      .from("meals")
      .select("*")
      .order("id", { ascending: false });

    document.getElementById("mealsList").innerHTML =
      data.map(m => `<p><b>${m.name}</b> ‚Äì ‚Ç¨${m.cost}</p>`).join("");
  }

  // ---------- UI ----------
  function showApp(user) {
    document.getElementById("authBox").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("userEmail").innerText = user.email;
    loadMeals();
  }

  function showMessage(text, error = false) {
    const el = document.getElementById("authMessage");
    el.innerText = text;
    el.style.color = error ? "red" : "green";
  }

  // ---------- SESSION CHECK ----------
  const { data: { session } } = await supabase.auth.getSession();
  if (session) showApp(session.user);

  // expose functions
  window.signUp = signUp;
  window.signIn = signIn;
  window.logout = logout;
  window.saveMeal = saveMeal;
</script>

</body>
</html>
